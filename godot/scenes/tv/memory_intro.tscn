[gd_scene load_steps=2 format=3 uid="uid://dqj8kmxryvpkr"]

[sub_resource type="GDScript" id="GDScript_memory_intro"]
script/source = "extends Control
## Memory Intro scene - Shows what's wrong for current memory

signal intro_complete

@onready var background: ColorRect = $Background
@onready var title_label: Label = $TitleLabel
@onready var description_label: Label = $DescriptionLabel
@onready var tomten_silhouette: Polygon2D = $TomtenSilhouette
@onready var problem_visual: Node2D = $ProblemVisual
@onready var continue_label: Label = $ContinueLabel

var _can_advance: bool = false
var _intro_shown: bool = false

# Memory data
const MEMORY_DATA := {
	1: {
		\"title\": \"[SWEDISH: The Christmas Porridge]\",
		\"description\": \"[SWEDISH: Tomten made porridge with SALT instead of sugar! The house spirits are upset and hiding.]\",
		\"visual\": \"porridge\"
	},
	2: {
		\"title\": \"[SWEDISH: The Lucia Procession]\",
		\"description\": \"[SWEDISH: The Lucia procession got lost in the dark following Tomten's confused directions.]\",
		\"visual\": \"lucia\"
	},
	3: {
		\"title\": \"[SWEDISH: The Christmas Tree]\",
		\"description\": \"[SWEDISH: Tomten decorated something that isn't quite a tree. The ornaments are confused.]\",
		\"visual\": \"tree\"
	},
	4: {
		\"title\": \"[SWEDISH: The Reindeer]\",
		\"description\": \"[SWEDISH: The reindeer won't respond because Tomten has forgotten their names.]\",
		\"visual\": \"reindeer\"
	},
	5: {
		\"title\": \"[SWEDISH: The Sleigh]\",
		\"description\": \"[SWEDISH: Tomten tried to fix the sleigh but attached wrong things. It's a mess!]\",
		\"visual\": \"sleigh\"
	},
	6: {
		\"title\": \"[SWEDISH: The Christmas Presents]\",
		\"description\": \"[SWEDISH: All the gift tags fell off. Tomten can't remember who gets what.]\",
		\"visual\": \"presents\"
	},
	7: {
		\"title\": \"[SWEDISH: The Christmas Star]\",
		\"description\": \"[SWEDISH: Tomten can't find the guiding star. Without it, he can't begin his journey.]\",
		\"visual\": \"star\"
	}
}


func _ready() -> void:
	continue_label.visible = false
	_setup_for_memory(GameState.current_memory)

	# Show intro after a brief delay
	await get_tree().create_timer(0.5).timeout
	_show_intro()


func _setup_for_memory(memory: int) -> void:
	if memory not in MEMORY_DATA:
		push_error(\"Unknown memory: %d\" % memory)
		return

	var data: Dictionary = MEMORY_DATA[memory]
	title_label.text = data[\"title\"]
	description_label.text = data[\"description\"]

	# Set background color based on memory
	if memory in [1, 3, 5, 6]:  # Indoor scenes
		background.color = Constants.Colors.WARM_BROWN
	else:  # Outdoor scenes
		background.color = Constants.Colors.NIGHT_DEEP_BLUE

	# Create visual for the problem
	_create_problem_visual(data[\"visual\"])

	# Create Tomten silhouette
	_create_tomten_silhouette()


func _create_tomten_silhouette() -> void:
	var points := PackedVector2Array([
		Vector2(0, 0),
		Vector2(-30, 60),
		Vector2(-40, 80),
		Vector2(-35, 120),
		Vector2(-50, 200),
		Vector2(-30, 250),
		Vector2(30, 250),
		Vector2(50, 200),
		Vector2(35, 120),
		Vector2(40, 80),
		Vector2(30, 60),
	])

	tomten_silhouette.polygon = points
	tomten_silhouette.color = Constants.Colors.TOMTEN_RED
	tomten_silhouette.position = Vector2(300, 700)


func _create_problem_visual(visual_type: String) -> void:
	# Clear existing children
	for child in problem_visual.get_children():
		child.queue_free()

	match visual_type:
		\"porridge\":
			_create_porridge_visual()
		\"lucia\":
			_create_lucia_visual()
		\"tree\":
			_create_tree_visual()
		\"reindeer\":
			_create_reindeer_visual()
		\"sleigh\":
			_create_sleigh_visual()
		\"presents\":
			_create_presents_visual()
		\"star\":
			_create_star_visual()


func _create_porridge_visual() -> void:
	# Create a sad-looking pot with salt spilling
	var pot := Polygon2D.new()
	pot.polygon = PackedVector2Array([
		Vector2(-60, 0),
		Vector2(-80, 100),
		Vector2(80, 100),
		Vector2(60, 0),
	])
	pot.color = Color(0.3, 0.3, 0.3)
	pot.position = Vector2(1200, 500)
	problem_visual.add_child(pot)

	# Salt shaker tipped over
	var salt := Polygon2D.new()
	salt.polygon = PackedVector2Array([
		Vector2(0, 0),
		Vector2(-15, 60),
		Vector2(15, 60),
	])
	salt.color = Color(0.9, 0.9, 0.9)
	salt.position = Vector2(1350, 450)
	salt.rotation = 0.5
	problem_visual.add_child(salt)


func _create_lucia_visual() -> void:
	# Show candles that are unlit
	for i in range(5):
		var candle := Polygon2D.new()
		candle.polygon = PackedVector2Array([
			Vector2(-8, 0),
			Vector2(-8, 60),
			Vector2(8, 60),
			Vector2(8, 0),
		])
		candle.color = Color(0.9, 0.9, 0.8)
		candle.position = Vector2(900 + i * 100, 400)
		problem_visual.add_child(candle)


func _create_tree_visual() -> void:
	# A wonky-looking tree shape
	var tree := Polygon2D.new()
	tree.polygon = PackedVector2Array([
		Vector2(0, 0),
		Vector2(-100, 150),
		Vector2(-60, 150),
		Vector2(-120, 280),
		Vector2(120, 280),
		Vector2(60, 150),
		Vector2(100, 150),
	])
	tree.color = Color(0.1, 0.4, 0.1)
	tree.position = Vector2(1200, 300)
	tree.rotation = 0.2  # Tilted!
	problem_visual.add_child(tree)


func _create_reindeer_visual() -> void:
	# Sad reindeer silhouette with question marks
	var reindeer := Polygon2D.new()
	reindeer.polygon = PackedVector2Array([
		Vector2(0, 0),
		Vector2(-20, 20),
		Vector2(-40, 10),
		Vector2(-50, 40),
		Vector2(-30, 80),
		Vector2(30, 80),
		Vector2(50, 40),
		Vector2(40, 10),
		Vector2(20, 20),
	])
	reindeer.color = Color(0.5, 0.3, 0.2)
	reindeer.position = Vector2(1200, 450)
	problem_visual.add_child(reindeer)

	# Question mark
	var question := Label.new()
	question.text = \"?\"
	question.add_theme_font_size_override(\"font_size\", 80)
	question.position = Vector2(1250, 350)
	problem_visual.add_child(question)


func _create_sleigh_visual() -> void:
	# Messy sleigh with wrong parts
	var sleigh_base := Polygon2D.new()
	sleigh_base.polygon = PackedVector2Array([
		Vector2(-100, 0),
		Vector2(-120, 40),
		Vector2(120, 40),
		Vector2(100, 0),
	])
	sleigh_base.color = Color(0.6, 0.2, 0.2)
	sleigh_base.position = Vector2(1200, 500)
	problem_visual.add_child(sleigh_base)

	# A wheel (wrong!)
	var wheel := Polygon2D.new()
	var wheel_points := PackedVector2Array()
	for i in range(16):
		var angle := i * TAU / 16
		wheel_points.append(Vector2(cos(angle) * 30, sin(angle) * 30))
	wheel.polygon = wheel_points
	wheel.color = Color(0.2, 0.2, 0.2)
	wheel.position = Vector2(1100, 550)
	problem_visual.add_child(wheel)


func _create_presents_visual() -> void:
	# Gifts with tags falling off
	for i in range(3):
		var gift := Polygon2D.new()
		gift.polygon = PackedVector2Array([
			Vector2(0, 0),
			Vector2(60, 0),
			Vector2(60, 50),
			Vector2(0, 50),
		])
		gift.color = [Color(0.8, 0.2, 0.2), Color(0.2, 0.6, 0.2), Color(0.2, 0.2, 0.8)][i]
		gift.position = Vector2(1000 + i * 120, 450)
		problem_visual.add_child(gift)


func _create_star_visual() -> void:
	# Night sky with no visible star
	var moon := Polygon2D.new()
	var moon_points := PackedVector2Array()
	for i in range(16):
		var angle := i * TAU / 16
		moon_points.append(Vector2(cos(angle) * 40, sin(angle) * 40))
	moon.polygon = moon_points
	moon.color = Color(0.9, 0.9, 0.7)
	moon.position = Vector2(1400, 200)
	problem_visual.add_child(moon)

	# Question where star should be
	var question := Label.new()
	question.text = \"?\"
	question.add_theme_font_size_override(\"font_size\", 100)
	question.add_theme_color_override(\"font_color\", Constants.Colors.HIGHLIGHT_GOLD)
	question.position = Vector2(1100, 100)
	problem_visual.add_child(question)


func _show_intro() -> void:
	# Animate title appearing
	var tween := create_tween()
	title_label.modulate.a = 0.0
	description_label.modulate.a = 0.0

	tween.tween_property(title_label, \"modulate:a\", 1.0, 0.5)
	tween.tween_interval(0.5)
	tween.tween_property(description_label, \"modulate:a\", 1.0, 0.5)

	await tween.finished

	_intro_shown = true
	_can_advance = true
	continue_label.visible = true


func _advance() -> void:
	if not _can_advance:
		return

	intro_complete.emit()
	GameState.advance_to_next_state()


func _input(event: InputEvent) -> void:
	if event is InputEventMouseButton and event.pressed:
		_advance()
	elif event is InputEventKey and event.pressed:
		if event.keycode == KEY_SPACE or event.keycode == KEY_ENTER:
			_advance()
"

[node name="MemoryIntro" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource("GDScript_memory_intro")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(0.545098, 0.270588, 0.0745098, 1)

[node name="TomtenSilhouette" type="Polygon2D" parent="."]
position = Vector2(300, 700)

[node name="ProblemVisual" type="Node2D" parent="."]

[node name="TitleLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -400.0
offset_top = 50.0
offset_right = 400.0
offset_bottom = 130.0
theme_override_font_sizes/font_size = 56
horizontal_alignment = 1
vertical_alignment = 1

[node name="DescriptionLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -600.0
offset_top = 150.0
offset_right = 600.0
offset_bottom = 250.0
theme_override_font_sizes/font_size = 32
horizontal_alignment = 1
vertical_alignment = 1
autowrap_mode = 2

[node name="ContinueLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -150.0
offset_top = -50.0
offset_right = 150.0
grow_horizontal = 2
grow_vertical = 0
theme_override_font_sizes/font_size = 20
text = "[Press SPACE to start the puzzle]"
horizontal_alignment = 1
