[gd_scene load_steps=2 format=3 uid="uid://drtjy2x8pqnav"]

[sub_resource type="GDScript" id="GDScript_ending"]
script/source = "extends Control
## Ending scene - Final sequence when all memories are restored

@onready var background: ColorRect = $Background
@onready var scene_container: Node2D = $SceneContainer
@onready var dialogue_label: Label = $DialogueBox/DialogueLabel
@onready var snow_particles: CPUParticles2D = $SnowParticles
@onready var star_particles: CPUParticles2D = $StarParticles
@onready var credits_container: VBoxContainer = $CreditsContainer

var _dialogue_index: int = 0
var _dialogues: Array[String] = [
	\"[SWEDISH: *The Christmas star blazes bright in the night sky...*]\",
	\"[SWEDISH: Tomten stands by his sleigh, all memories restored.]\",
	\"[SWEDISH: The reindeer paw the snow eagerly, ready for the journey.]\",
	\"[SWEDISH: Tomten: 'Thank you, dear friends.']\",
	\"[SWEDISH: Tomten: 'You gave me Christmas back.']\",
	\"[SWEDISH: Tomten: 'I remember everything now - the joy, the traditions, the love.']\",
	\"[SWEDISH: Tomten climbs into the sleigh and takes the reins.]\",
	\"[SWEDISH: Tomten: 'God jul, allihopa!']\",
	\"[SWEDISH: *The sleigh rises into the starlit sky...*]\",
]

var _can_advance: bool = false
var _typing_speed: float = 0.03
var _is_typing: bool = false
var _in_credits: bool = false


func _ready() -> void:
	credits_container.visible = false
	_setup_visuals()
	_show_dialogue()


func _setup_visuals() -> void:
	# Night sky background
	background.color = Constants.Colors.NIGHT_DEEP_BLUE

	# Setup snow
	_setup_snow()

	# Setup star particles (golden sparkles)
	_setup_star_particles()

	# Create the ending scene
	_create_ending_scene()


func _setup_snow() -> void:
	snow_particles.emitting = true
	snow_particles.amount = 150
	snow_particles.lifetime = 10.0
	snow_particles.emission_shape = CPUParticles2D.EMISSION_SHAPE_RECTANGLE
	snow_particles.emission_rect_extents = Vector2(1000, 10)
	snow_particles.direction = Vector2(0.2, 1)
	snow_particles.spread = 10.0
	snow_particles.gravity = Vector2(10, 40)
	snow_particles.initial_velocity_min = 20.0
	snow_particles.initial_velocity_max = 40.0
	snow_particles.scale_amount_min = 2.0
	snow_particles.scale_amount_max = 4.0
	snow_particles.color = Constants.Colors.SNOW_BLUE_WHITE
	snow_particles.position = Vector2(960, 0)


func _setup_star_particles() -> void:
	star_particles.emitting = true
	star_particles.amount = 30
	star_particles.lifetime = 3.0
	star_particles.emission_shape = CPUParticles2D.EMISSION_SHAPE_RECTANGLE
	star_particles.emission_rect_extents = Vector2(800, 300)
	star_particles.direction = Vector2(0, 0)
	star_particles.spread = 180.0
	star_particles.gravity = Vector2(0, 0)
	star_particles.initial_velocity_min = 5.0
	star_particles.initial_velocity_max = 15.0
	star_particles.scale_amount_min = 2.0
	star_particles.scale_amount_max = 5.0
	star_particles.color = Constants.Colors.HIGHLIGHT_GOLD
	star_particles.position = Vector2(960, 400)


func _create_ending_scene() -> void:
	# Christmas star at the top
	var star := _create_star_shape(40)
	star.color = Constants.Colors.HIGHLIGHT_GOLD
	star.position = Vector2(960, 150)
	scene_container.add_child(star)

	# Moon
	var moon := Polygon2D.new()
	var moon_points := PackedVector2Array()
	for i in range(20):
		var angle := i * TAU / 20
		moon_points.append(Vector2(cos(angle) * 50, sin(angle) * 50))
	moon.polygon = moon_points
	moon.color = Color(0.95, 0.95, 0.8)
	moon.position = Vector2(1600, 200)
	scene_container.add_child(moon)

	# Snowy ground
	var ground := Polygon2D.new()
	ground.polygon = PackedVector2Array([
		Vector2(0, 800), Vector2(0, 700),
		Vector2(200, 680), Vector2(500, 720),
		Vector2(800, 690), Vector2(1100, 730),
		Vector2(1400, 700), Vector2(1700, 720),
		Vector2(1920, 690), Vector2(1920, 800),
	])
	ground.color = Constants.Colors.SNOW_BLUE_WHITE
	ground.position = Vector2(0, 200)
	scene_container.add_child(ground)

	# Sleigh
	_create_sleigh()

	# Reindeer
	_create_reindeer()

	# Tomten in sleigh
	_create_tomten_in_sleigh()


func _create_star_shape(size: float) -> Polygon2D:
	var star := Polygon2D.new()
	var points := PackedVector2Array()
	for i in range(10):
		var angle := i * TAU / 10 - TAU / 4
		var radius := size if i % 2 == 0 else size * 0.4
		points.append(Vector2(cos(angle) * radius, sin(angle) * radius))
	star.polygon = points
	return star


func _create_sleigh() -> void:
	var sleigh := Polygon2D.new()
	sleigh.polygon = PackedVector2Array([
		Vector2(-100, 0), Vector2(-130, 50),
		Vector2(130, 50), Vector2(100, 0),
		Vector2(80, -30), Vector2(-80, -30),
	])
	sleigh.color = Color(0.7, 0.15, 0.15)
	sleigh.position = Vector2(1400, 700)
	sleigh.name = \"Sleigh\"
	scene_container.add_child(sleigh)

	# Runners
	var runner := Polygon2D.new()
	runner.polygon = PackedVector2Array([
		Vector2(-140, 0), Vector2(-160, 15), Vector2(160, 15), Vector2(140, 0),
	])
	runner.color = Color(0.6, 0.5, 0.1)
	runner.position = Vector2(1400, 750)
	runner.name = \"Runner\"
	scene_container.add_child(runner)


func _create_reindeer() -> void:
	for i in range(4):
		var reindeer := Polygon2D.new()
		reindeer.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(-15, 15), Vector2(-30, 10),
			Vector2(-40, 30), Vector2(-25, 60), Vector2(25, 60),
			Vector2(40, 30), Vector2(30, 10), Vector2(15, 15),
		])
		reindeer.color = Color(0.45, 0.28, 0.18)
		reindeer.position = Vector2(900 + i * 100, 720)
		reindeer.name = \"Reindeer%d\" % i
		scene_container.add_child(reindeer)


func _create_tomten_in_sleigh() -> void:
	var tomten := Polygon2D.new()
	tomten.polygon = PackedVector2Array([
		Vector2(0, 0), Vector2(-20, 40), Vector2(-25, 60),
		Vector2(-20, 90), Vector2(20, 90), Vector2(25, 60),
		Vector2(20, 40),
	])
	tomten.color = Constants.Colors.TOMTEN_RED
	tomten.position = Vector2(1400, 620)
	tomten.name = \"TomtenInSleigh\"
	scene_container.add_child(tomten)


func _show_dialogue() -> void:
	if _dialogue_index >= _dialogues.size():
		_start_sleigh_animation()
		return

	_is_typing = true
	_can_advance = false

	var text := _dialogues[_dialogue_index]
	dialogue_label.text = \"\"

	for i in range(text.length()):
		dialogue_label.text += text[i]
		await get_tree().create_timer(_typing_speed).timeout

		if not _is_typing:  # Skipped
			break

	_is_typing = false
	_can_advance = true


func _advance_dialogue() -> void:
	if _in_credits:
		return

	if _is_typing:
		dialogue_label.text = _dialogues[_dialogue_index]
		_is_typing = false
		_can_advance = true
	elif _can_advance:
		_dialogue_index += 1
		_show_dialogue()


func _start_sleigh_animation() -> void:
	_can_advance = false
	dialogue_label.text = \"\"

	# Animate sleigh flying up and across
	var sleigh := scene_container.get_node(\"Sleigh\")
	var runner := scene_container.get_node(\"Runner\")
	var tomten := scene_container.get_node(\"TomtenInSleigh\")

	# Get reindeer
	var reindeer := []
	for i in range(4):
		reindeer.append(scene_container.get_node(\"Reindeer%d\" % i))

	# Animate everything flying
	var tween := create_tween()
	tween.set_parallel(true)

	# Sleigh and tomten
	tween.tween_property(sleigh, \"position\", Vector2(2200, 100), 4.0).set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_IN_OUT)
	tween.tween_property(runner, \"position\", Vector2(2200, 150), 4.0).set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_IN_OUT)
	tween.tween_property(tomten, \"position\", Vector2(2200, 20), 4.0).set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_IN_OUT)

	# Reindeer
	for i in range(4):
		var target := Vector2(1700 + i * 100, 80 + i * 10)
		tween.tween_property(reindeer[i], \"position\", target, 4.0).set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_IN_OUT)

	await tween.finished

	# Show credits
	await get_tree().create_timer(1.0).timeout
	_show_credits()


func _show_credits() -> void:
	_in_credits = true
	credits_container.visible = true
	credits_container.modulate.a = 0.0

	# Fade in credits
	var tween := create_tween()
	tween.tween_property(credits_container, \"modulate:a\", 1.0, 1.0)


func _input(event: InputEvent) -> void:
	if event is InputEventMouseButton and event.pressed:
		_advance_dialogue()
	elif event is InputEventKey and event.pressed:
		if event.keycode == KEY_SPACE or event.keycode == KEY_ENTER:
			_advance_dialogue()
"

[node name="Ending" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource("GDScript_ending")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(0.101961, 0.101961, 0.180392, 1)

[node name="SceneContainer" type="Node2D" parent="."]

[node name="SnowParticles" type="CPUParticles2D" parent="."]
position = Vector2(960, 0)
emitting = false

[node name="StarParticles" type="CPUParticles2D" parent="."]
position = Vector2(960, 400)
emitting = false

[node name="DialogueBox" type="PanelContainer" parent="."]
layout_mode = 1
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 100.0
offset_top = -150.0
offset_right = -100.0
offset_bottom = -30.0
grow_horizontal = 2
grow_vertical = 0

[node name="DialogueLabel" type="Label" parent="DialogueBox"]
layout_mode = 2
theme_override_font_sizes/font_size = 28
horizontal_alignment = 1
vertical_alignment = 1
autowrap_mode = 2

[node name="CreditsContainer" type="VBoxContainer" parent="."]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -300.0
offset_top = -150.0
offset_right = 300.0
offset_bottom = 150.0
grow_horizontal = 2
grow_vertical = 2

[node name="Title" type="Label" parent="CreditsContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 56
text = "Tomtens FÃ¶rsvunna Minnen"
horizontal_alignment = 1

[node name="Subtitle" type="Label" parent="CreditsContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 32
text = "[SWEDISH: The End]"
horizontal_alignment = 1

[node name="Spacer" type="Control" parent="CreditsContainer"]
custom_minimum_size = Vector2(0, 40)
layout_mode = 2

[node name="ThankYou" type="Label" parent="CreditsContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 28
text = "[SWEDISH: Thank you for playing!]"
horizontal_alignment = 1

[node name="GodJul" type="Label" parent="CreditsContainer"]
layout_mode = 2
theme_override_font_sizes/font_size = 48
theme_override_colors/font_color = Color(1, 0.843137, 0, 1)
text = "God Jul! ðŸŽ„"
horizontal_alignment = 1
