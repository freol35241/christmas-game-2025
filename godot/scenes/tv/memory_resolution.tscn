[gd_scene load_steps=2 format=3 uid="uid://cm7qj3xnk6yrd"]

[sub_resource type="GDScript" id="GDScript_resolution"]
script/source = "extends Control
## Memory Resolution scene - Shows memory being restored

signal resolution_complete

@onready var background: ColorRect = $Background
@onready var title_label: Label = $TitleLabel
@onready var description_label: Label = $DescriptionLabel
@onready var visual_container: Node2D = $VisualContainer
@onready var tomten_silhouette: Polygon2D = $TomtenSilhouette
@onready var memory_glow: ColorRect = $MemoryGlow
@onready var sparkle_particles: CPUParticles2D = $SparkleParticles
@onready var progress_stars: HBoxContainer = $ProgressStars
@onready var continue_label: Label = $ContinueLabel

var _animation_done: bool = false
var _can_advance: bool = false

# Resolution data
const RESOLUTION_DATA := {
	1: {
		\"title\": \"[SWEDISH: The Porridge Memory Returns!]\",
		\"description\": \"[SWEDISH: The tomtenissar peek out and approach the (now correct) porridge bowl. They look happy!]\",
	},
	2: {
		\"title\": \"[SWEDISH: The Lucia Memory Returns!]\",
		\"description\": \"[SWEDISH: The Lucia procession arrives at Tomten's cottage, candles glowing in the dark. Beautiful!]\",
	},
	3: {
		\"title\": \"[SWEDISH: The Tree Memory Returns!]\",
		\"description\": \"[SWEDISH: The Christmas tree lights up beautifully, ornaments twinkling. Tomten gazes in wonder.]\",
	},
	4: {
		\"title\": \"[SWEDISH: The Reindeer Memory Returns!]\",
		\"description\": \"[SWEDISH: The reindeer come trotting back across the snowy field, nuzzling Tomten. He remembers each name!]\",
	},
	5: {
		\"title\": \"[SWEDISH: The Sleigh Memory Returns!]\",
		\"description\": \"[SWEDISH: The sleigh gleams, properly assembled, hovering slightly. Ready to fly!]\",
	},
	6: {
		\"title\": \"[SWEDISH: The Presents Memory Returns!]\",
		\"description\": \"[SWEDISH: The gift tags magically reattach. Tomten smiles, remembering the care behind each choice.]\",
	},
	7: {
		\"title\": \"[SWEDISH: The Star Memory Returns!]\",
		\"description\": \"[SWEDISH: The Christmas star blazes bright in the sky! All seven memories are restored!]\",
	}
}


func _ready() -> void:
	continue_label.visible = false
	memory_glow.modulate.a = 0.0
	sparkle_particles.emitting = false

	_setup_for_memory(GameState.current_memory)
	_update_progress_stars()

	# Start animation sequence
	await get_tree().create_timer(0.5).timeout
	_play_resolution_animation()


func _setup_for_memory(memory: int) -> void:
	if memory not in RESOLUTION_DATA:
		push_error(\"Unknown memory for resolution: %d\" % memory)
		return

	var data: Dictionary = RESOLUTION_DATA[memory]
	title_label.text = data[\"title\"]
	description_label.text = data[\"description\"]

	# Warm background for resolution
	background.color = Constants.Colors.WARM_AMBER

	# Create Tomten
	_create_tomten_silhouette()

	# Create resolution visual
	_create_resolution_visual(memory)


func _create_tomten_silhouette() -> void:
	var points := PackedVector2Array([
		Vector2(0, 0),
		Vector2(-30, 60),
		Vector2(-40, 80),
		Vector2(-35, 120),
		Vector2(-50, 200),
		Vector2(-30, 250),
		Vector2(30, 250),
		Vector2(50, 200),
		Vector2(35, 120),
		Vector2(40, 80),
		Vector2(30, 60),
	])

	tomten_silhouette.polygon = points
	tomten_silhouette.color = Constants.Colors.TOMTEN_RED
	tomten_silhouette.position = Vector2(400, 650)


func _create_resolution_visual(memory: int) -> void:
	for child in visual_container.get_children():
		child.queue_free()

	match memory:
		1: _create_porridge_happy()
		2: _create_lucia_arrived()
		3: _create_tree_lit()
		4: _create_reindeer_happy()
		5: _create_sleigh_ready()
		6: _create_presents_tagged()
		7: _create_star_shining()


func _create_porridge_happy() -> void:
	# Happy pot with steam
	var pot := Polygon2D.new()
	pot.polygon = PackedVector2Array([
		Vector2(-60, 0), Vector2(-80, 100), Vector2(80, 100), Vector2(60, 0),
	])
	pot.color = Color(0.4, 0.4, 0.4)
	pot.position = Vector2(1100, 500)
	visual_container.add_child(pot)

	# Little tomtenissar (small silhouettes)
	for i in range(3):
		var nissar := Polygon2D.new()
		nissar.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(-10, 20), Vector2(-15, 40),
			Vector2(-8, 50), Vector2(8, 50), Vector2(15, 40),
			Vector2(10, 20),
		])
		nissar.color = Color(0.6, 0.1, 0.1)
		nissar.position = Vector2(950 + i * 80, 550)
		visual_container.add_child(nissar)


func _create_lucia_arrived() -> void:
	# Glowing candles in a row
	for i in range(7):
		var candle := Polygon2D.new()
		candle.polygon = PackedVector2Array([
			Vector2(-6, 0), Vector2(-6, 50), Vector2(6, 50), Vector2(6, 0),
		])
		candle.color = Color(0.95, 0.95, 0.85)
		candle.position = Vector2(800 + i * 70, 450)
		visual_container.add_child(candle)

		# Flame
		var flame := Polygon2D.new()
		flame.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(-8, 20), Vector2(0, 35), Vector2(8, 20),
		])
		flame.color = Constants.Colors.WARM_DEEP_ORANGE
		flame.position = Vector2(800 + i * 70, 420)
		visual_container.add_child(flame)


func _create_tree_lit() -> void:
	# Beautiful tree
	var tree := Polygon2D.new()
	tree.polygon = PackedVector2Array([
		Vector2(0, 0), Vector2(-100, 150), Vector2(-60, 150),
		Vector2(-120, 280), Vector2(120, 280), Vector2(60, 150),
		Vector2(100, 150),
	])
	tree.color = Color(0.1, 0.5, 0.1)
	tree.position = Vector2(1100, 350)
	visual_container.add_child(tree)

	# Star on top
	var star := _create_star_shape(15)
	star.color = Constants.Colors.HIGHLIGHT_GOLD
	star.position = Vector2(1100, 350)
	visual_container.add_child(star)


func _create_reindeer_happy() -> void:
	for i in range(4):
		var reindeer := Polygon2D.new()
		reindeer.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(-20, 20), Vector2(-40, 10),
			Vector2(-50, 40), Vector2(-30, 80), Vector2(30, 80),
			Vector2(50, 40), Vector2(40, 10), Vector2(20, 20),
		])
		reindeer.color = Color(0.5, 0.3, 0.2)
		reindeer.position = Vector2(800 + i * 120, 500)
		visual_container.add_child(reindeer)


func _create_sleigh_ready() -> void:
	var sleigh := Polygon2D.new()
	sleigh.polygon = PackedVector2Array([
		Vector2(-120, 0), Vector2(-150, 60),
		Vector2(150, 60), Vector2(120, 0),
		Vector2(100, -30), Vector2(-100, -30),
	])
	sleigh.color = Color(0.7, 0.15, 0.15)
	sleigh.position = Vector2(1100, 500)
	visual_container.add_child(sleigh)

	# Runners
	var runner := Polygon2D.new()
	runner.polygon = PackedVector2Array([
		Vector2(-160, 0), Vector2(-180, 20), Vector2(180, 20), Vector2(160, 0),
	])
	runner.color = Color(0.6, 0.5, 0.1)
	runner.position = Vector2(1100, 560)
	visual_container.add_child(runner)


func _create_presents_tagged() -> void:
	var colors := [Color(0.8, 0.2, 0.2), Color(0.2, 0.6, 0.2),
				   Color(0.2, 0.2, 0.8), Color(0.8, 0.6, 0.2)]
	for i in range(4):
		var gift := Polygon2D.new()
		gift.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(60, 0), Vector2(60, 50), Vector2(0, 50),
		])
		gift.color = colors[i]
		gift.position = Vector2(850 + i * 100, 500)
		visual_container.add_child(gift)

		# Tag
		var tag := Polygon2D.new()
		tag.polygon = PackedVector2Array([
			Vector2(0, 0), Vector2(20, 0), Vector2(20, 15), Vector2(0, 15),
		])
		tag.color = Color(0.95, 0.95, 0.9)
		tag.position = Vector2(870 + i * 100, 480)
		visual_container.add_child(tag)


func _create_star_shining() -> void:
	# Big glowing star
	var star := _create_star_shape(60)
	star.color = Constants.Colors.HIGHLIGHT_GOLD
	star.position = Vector2(1100, 300)
	visual_container.add_child(star)


func _create_star_shape(size: float) -> Polygon2D:
	var star := Polygon2D.new()
	var points := PackedVector2Array()
	for i in range(10):
		var angle := i * TAU / 10 - TAU / 4
		var radius := size if i % 2 == 0 else size * 0.4
		points.append(Vector2(cos(angle) * radius, sin(angle) * radius))
	star.polygon = points
	return star


func _update_progress_stars() -> void:
	# Clear existing stars
	for child in progress_stars.get_children():
		child.queue_free()

	# Add 7 stars showing progress
	for i in range(1, 8):
		var star_label := Label.new()
		star_label.add_theme_font_size_override(\"font_size\", 40)

		if GameState.is_memory_completed(i) or i == GameState.current_memory:
			star_label.text = \"★\"
			star_label.add_theme_color_override(\"font_color\", Constants.Colors.HIGHLIGHT_GOLD)
		else:
			star_label.text = \"☆\"
			star_label.add_theme_color_override(\"font_color\", Color(0.5, 0.5, 0.5))

		progress_stars.add_child(star_label)


func _play_resolution_animation() -> void:
	# Title fade in
	title_label.modulate.a = 0.0
	var tween := create_tween()
	tween.tween_property(title_label, \"modulate:a\", 1.0, 0.5)

	await tween.finished

	# Description fade in
	description_label.modulate.a = 0.0
	tween = create_tween()
	tween.tween_property(description_label, \"modulate:a\", 1.0, 0.5)

	await tween.finished
	await get_tree().create_timer(1.0).timeout

	# Memory glow animation
	tween = create_tween()
	tween.tween_property(memory_glow, \"modulate:a\", 0.8, 1.0)
	tween.tween_property(memory_glow, \"modulate:a\", 0.0, 1.0)

	# Start sparkles
	sparkle_particles.emitting = true
	_setup_sparkles()

	await tween.finished
	await get_tree().create_timer(1.0).timeout

	_animation_done = true
	_can_advance = true
	continue_label.visible = true


func _setup_sparkles() -> void:
	sparkle_particles.amount = 50
	sparkle_particles.lifetime = 2.0
	sparkle_particles.emission_shape = CPUParticles2D.EMISSION_SHAPE_RECTANGLE
	sparkle_particles.emission_rect_extents = Vector2(200, 100)
	sparkle_particles.direction = Vector2(0, -1)
	sparkle_particles.spread = 45.0
	sparkle_particles.gravity = Vector2(0, 50)
	sparkle_particles.initial_velocity_min = 50.0
	sparkle_particles.initial_velocity_max = 100.0
	sparkle_particles.scale_amount_min = 3.0
	sparkle_particles.scale_amount_max = 6.0
	sparkle_particles.color = Constants.Colors.HIGHLIGHT_GOLD
	sparkle_particles.position = Vector2(960, 540)


func _advance() -> void:
	if not _can_advance:
		return

	resolution_complete.emit()
	GameState.advance_to_next_state()


func _input(event: InputEvent) -> void:
	if event is InputEventMouseButton and event.pressed:
		if _animation_done:
			_advance()
	elif event is InputEventKey and event.pressed:
		if event.keycode == KEY_SPACE or event.keycode == KEY_ENTER:
			if _animation_done:
				_advance()
"

[node name="MemoryResolution" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource("GDScript_resolution")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(1, 0.701961, 0.278431, 1)

[node name="MemoryGlow" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(1, 0.843137, 0, 0.5)

[node name="VisualContainer" type="Node2D" parent="."]

[node name="TomtenSilhouette" type="Polygon2D" parent="."]
position = Vector2(400, 650)

[node name="SparkleParticles" type="CPUParticles2D" parent="."]
position = Vector2(960, 540)
emitting = false

[node name="TitleLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -400.0
offset_top = 50.0
offset_right = 400.0
offset_bottom = 120.0
theme_override_font_sizes/font_size = 48
horizontal_alignment = 1
vertical_alignment = 1

[node name="DescriptionLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -600.0
offset_top = 140.0
offset_right = 600.0
offset_bottom = 220.0
theme_override_font_sizes/font_size = 28
horizontal_alignment = 1
vertical_alignment = 1
autowrap_mode = 2

[node name="ProgressStars" type="HBoxContainer" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -200.0
offset_top = 240.0
offset_right = 200.0
offset_bottom = 290.0
theme_override_constants/separation = 20
alignment = 1

[node name="ContinueLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -150.0
offset_top = -50.0
offset_right = 150.0
grow_horizontal = 2
grow_vertical = 0
theme_override_font_sizes/font_size = 20
text = "[Press SPACE to continue]"
horizontal_alignment = 1
