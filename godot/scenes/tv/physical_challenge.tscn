[gd_scene load_steps=2 format=3 uid="uid://br5gxm2qpk8cn"]

[sub_resource type="GDScript" id="GDScript_physical"]
script/source = "extends Control
## Physical Challenge scene - Camera-based activity display

signal challenge_complete(success: bool)

@onready var background: ColorRect = $Background
@onready var title_label: Label = $TitleLabel
@onready var instruction_label: Label = $InstructionLabel
@onready var visual_container: Node2D = $VisualContainer
@onready var progress_bar: ProgressBar = $ProgressBar
@onready var attempts_label: Label = $AttemptsLabel
@onready var feedback_label: Label = $FeedbackLabel
@onready var detection_indicator: ColorRect = $DetectionIndicator

var _challenge_active: bool = false
var _detection_progress: float = 0.0
var _required_duration: float = 5.0
var _is_detecting: bool = false

# Challenge data
const CHALLENGE_DATA := {
	1: {
		\"title\": \"[SWEDISH: Stir the Porridge!]\",
		\"instruction\": \"[SWEDISH: Everyone make stirring motions together!]\",
		\"visual\": \"stirring\",
		\"duration\": 5.0
	},
	2: {
		\"title\": \"[SWEDISH: Lucia Procession!]\",
		\"instruction\": \"[SWEDISH: Walk in a line across the room!]\",
		\"visual\": \"walking\",
		\"duration\": 3.0
	},
	3: {
		\"title\": \"[SWEDISH: Make a Tree Shape!]\",
		\"instruction\": \"[SWEDISH: Form a Christmas tree together!]\",
		\"visual\": \"tree_pose\",
		\"duration\": 3.0
	},
	4: {
		\"title\": \"[SWEDISH: Reindeer Antlers!]\",
		\"instruction\": \"[SWEDISH: Put your hands up like antlers!]\",
		\"visual\": \"antlers\",
		\"duration\": 3.0
	},
	5: {
		\"title\": \"[SWEDISH: Sleigh Ride!]\",
		\"instruction\": \"[SWEDISH: Sit together and bob up and down like riding!]\",
		\"visual\": \"sleigh_ride\",
		\"duration\": 5.0
	},
	6: {
		\"title\": \"[SWEDISH: Find Something RED!]\",
		\"instruction\": \"[SWEDISH: Find a red object and show it to the camera!]\",
		\"visual\": \"red_object\",
		\"duration\": 2.0
	},
	7: {
		\"title\": \"[SWEDISH: Form a Star!]\",
		\"instruction\": \"[SWEDISH: Make a star shape together - the final challenge!]\",
		\"visual\": \"star_pose\",
		\"duration\": 4.0
	}
}


func _ready() -> void:
	_setup_for_memory(GameState.current_memory)
	_challenge_active = true
	progress_bar.value = 0
	detection_indicator.color = Color(0.5, 0.5, 0.5)
	feedback_label.text = \"\"


func _process(delta: float) -> void:
	if not _challenge_active:
		return

	# Update attempts display
	attempts_label.text = \"[SWEDISH: Attempts: %d / %d]\" % [
		GameState.physical_attempts,
		Constants.MAX_PHYSICAL_ATTEMPTS
	]

	# If detecting, increase progress
	if _is_detecting:
		_detection_progress += delta
		progress_bar.value = (_detection_progress / _required_duration) * 100.0
		detection_indicator.color = Constants.Colors.SUCCESS_GREEN

		if _detection_progress >= _required_duration:
			_complete_challenge(true)
	else:
		detection_indicator.color = Color(0.5, 0.5, 0.5)


func _setup_for_memory(memory: int) -> void:
	if memory not in CHALLENGE_DATA:
		push_error(\"Unknown memory for challenge: %d\" % memory)
		return

	var data: Dictionary = CHALLENGE_DATA[memory]
	title_label.text = data[\"title\"]
	instruction_label.text = data[\"instruction\"]
	_required_duration = data[\"duration\"]

	# Set background color
	if memory in [1, 3, 5, 6]:
		background.color = Constants.Colors.WARM_BROWN
	else:
		background.color = Constants.Colors.NIGHT_DEEP_BLUE

	# Create visual hint
	_create_visual_hint(data[\"visual\"])


func _create_visual_hint(visual_type: String) -> void:
	for child in visual_container.get_children():
		child.queue_free()

	match visual_type:
		\"stirring\":
			_create_stirring_visual()
		\"walking\":
			_create_walking_visual()
		\"tree_pose\":
			_create_tree_pose_visual()
		\"antlers\":
			_create_antlers_visual()
		\"sleigh_ride\":
			_create_sleigh_ride_visual()
		\"red_object\":
			_create_red_object_visual()
		\"star_pose\":
			_create_star_pose_visual()


func _create_stirring_visual() -> void:
	# Show a pot with circular arrows
	var pot := Polygon2D.new()
	pot.polygon = PackedVector2Array([
		Vector2(-80, 0),
		Vector2(-100, 120),
		Vector2(100, 120),
		Vector2(80, 0),
	])
	pot.color = Color(0.4, 0.4, 0.4)
	pot.position = Vector2(960, 500)
	visual_container.add_child(pot)

	# Circular arrow hint
	var arrow := Label.new()
	arrow.text = \"↻\"
	arrow.add_theme_font_size_override(\"font_size\", 150)
	arrow.position = Vector2(900, 300)
	visual_container.add_child(arrow)


func _create_walking_visual() -> void:
	# Show silhouettes walking
	for i in range(3):
		var person := Polygon2D.new()
		person.polygon = PackedVector2Array([
			Vector2(0, 0),
			Vector2(-15, 30),
			Vector2(-20, 80),
			Vector2(-10, 80),
			Vector2(0, 50),
			Vector2(10, 80),
			Vector2(20, 80),
			Vector2(15, 30),
		])
		person.color = Color(0.3, 0.3, 0.3)
		person.position = Vector2(700 + i * 150, 500)
		visual_container.add_child(person)

	# Arrow showing direction
	var arrow := Label.new()
	arrow.text = \"→→→\"
	arrow.add_theme_font_size_override(\"font_size\", 80)
	arrow.position = Vector2(850, 350)
	visual_container.add_child(arrow)


func _create_tree_pose_visual() -> void:
	# Show people forming triangle
	var hint := Label.new()
	hint.text = \"△\"
	hint.add_theme_font_size_override(\"font_size\", 200)
	hint.add_theme_color_override(\"font_color\", Color(0.2, 0.6, 0.2))
	hint.position = Vector2(880, 350)
	visual_container.add_child(hint)


func _create_antlers_visual() -> void:
	# Show hands above head
	var head := Polygon2D.new()
	var head_points := PackedVector2Array()
	for i in range(16):
		var angle := i * TAU / 16
		head_points.append(Vector2(cos(angle) * 40, sin(angle) * 40))
	head.polygon = head_points
	head.color = Color(0.4, 0.4, 0.4)
	head.position = Vector2(960, 500)
	visual_container.add_child(head)

	# Hands as antlers
	var left_hand := Polygon2D.new()
	left_hand.polygon = PackedVector2Array([
		Vector2(0, 0), Vector2(-30, -60), Vector2(-20, -80),
		Vector2(-10, -60), Vector2(0, -70), Vector2(10, -60),
	])
	left_hand.color = Color(0.5, 0.4, 0.3)
	left_hand.position = Vector2(910, 450)
	visual_container.add_child(left_hand)

	var right_hand := Polygon2D.new()
	right_hand.polygon = PackedVector2Array([
		Vector2(0, 0), Vector2(30, -60), Vector2(20, -80),
		Vector2(10, -60), Vector2(0, -70), Vector2(-10, -60),
	])
	right_hand.color = Color(0.5, 0.4, 0.3)
	right_hand.position = Vector2(1010, 450)
	visual_container.add_child(right_hand)


func _create_sleigh_ride_visual() -> void:
	# Show people bobbing
	var hint := Label.new()
	hint.text = \"↕↕↕\"
	hint.add_theme_font_size_override(\"font_size\", 100)
	hint.position = Vector2(850, 400)
	visual_container.add_child(hint)

	# Sleigh shape
	var sleigh := Polygon2D.new()
	sleigh.polygon = PackedVector2Array([
		Vector2(-150, 0),
		Vector2(-180, 50),
		Vector2(180, 50),
		Vector2(150, 0),
	])
	sleigh.color = Color(0.6, 0.2, 0.2)
	sleigh.position = Vector2(960, 550)
	visual_container.add_child(sleigh)


func _create_red_object_visual() -> void:
	# Show a big red circle
	var red_circle := Polygon2D.new()
	var points := PackedVector2Array()
	for i in range(32):
		var angle := i * TAU / 32
		points.append(Vector2(cos(angle) * 80, sin(angle) * 80))
	red_circle.polygon = points
	red_circle.color = Color(0.9, 0.1, 0.1)
	red_circle.position = Vector2(960, 450)
	visual_container.add_child(red_circle)

	# Question mark
	var question := Label.new()
	question.text = \"?\"
	question.add_theme_font_size_override(\"font_size\", 100)
	question.add_theme_color_override(\"font_color\", Color.WHITE)
	question.position = Vector2(930, 380)
	visual_container.add_child(question)


func _create_star_pose_visual() -> void:
	# Show star shape
	var star := Polygon2D.new()
	var points := PackedVector2Array()
	for i in range(10):
		var angle := i * TAU / 10 - TAU / 4
		var radius := 80.0 if i % 2 == 0 else 40.0
		points.append(Vector2(cos(angle) * radius, sin(angle) * radius))
	star.polygon = points
	star.color = Constants.Colors.HIGHLIGHT_GOLD
	star.position = Vector2(960, 450)
	visual_container.add_child(star)


# Called by TV controller when camera sends detection update
func on_detection_update(message: Dictionary) -> void:
	_is_detecting = message.get(\"detected\", false)

	if _is_detecting:
		feedback_label.text = \"[SWEDISH: Great! Keep going!]\"
		feedback_label.add_theme_color_override(\"font_color\", Constants.Colors.SUCCESS_GREEN)
	else:
		feedback_label.text = \"[SWEDISH: Try the pose shown above!]\"
		feedback_label.add_theme_color_override(\"font_color\", Color.WHITE)


func _complete_challenge(success: bool) -> void:
	_challenge_active = false

	if success:
		feedback_label.text = \"[SWEDISH: Wonderful! You did it!]\"
		feedback_label.add_theme_color_override(\"font_color\", Constants.Colors.HIGHLIGHT_GOLD)

		# Celebration animation
		var tween := create_tween()
		tween.tween_property(progress_bar, \"modulate\", Constants.Colors.HIGHLIGHT_GOLD, 0.3)
		tween.tween_property(progress_bar, \"modulate\", Color.WHITE, 0.3)
		tween.set_loops(3)

		await get_tree().create_timer(2.0).timeout
	else:
		feedback_label.text = \"[SWEDISH: Good effort! Let's continue!]\"

	challenge_complete.emit(success)


func _input(event: InputEvent) -> void:
	# Debug: simulate detection with spacebar
	if event is InputEventKey:
		if event.keycode == KEY_SPACE:
			_is_detecting = event.pressed
			if not event.pressed:
				_detection_progress = max(0, _detection_progress - 0.5)

		# Debug: auto-pass with P key
		if event.keycode == KEY_P and event.pressed and _challenge_active:
			_complete_challenge(true)
"

[node name="PhysicalChallenge" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource("GDScript_physical")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(0.545098, 0.270588, 0.0745098, 1)

[node name="VisualContainer" type="Node2D" parent="."]

[node name="TitleLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -400.0
offset_top = 50.0
offset_right = 400.0
offset_bottom = 120.0
theme_override_font_sizes/font_size = 48
horizontal_alignment = 1
vertical_alignment = 1

[node name="InstructionLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -500.0
offset_top = 140.0
offset_right = 500.0
offset_bottom = 200.0
theme_override_font_sizes/font_size = 32
horizontal_alignment = 1
vertical_alignment = 1
autowrap_mode = 2

[node name="ProgressBar" type="ProgressBar" parent="."]
layout_mode = 1
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 200.0
offset_top = -100.0
offset_right = -200.0
offset_bottom = -60.0
grow_horizontal = 2
grow_vertical = 0
value = 50.0
show_percentage = false

[node name="AttemptsLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 2
anchor_left = 1.0
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -250.0
offset_top = -50.0
offset_right = -20.0
grow_horizontal = 0
grow_vertical = 0
theme_override_font_sizes/font_size = 20
horizontal_alignment = 2

[node name="FeedbackLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -300.0
offset_top = -150.0
offset_right = 300.0
offset_bottom = -110.0
grow_horizontal = 2
grow_vertical = 0
theme_override_font_sizes/font_size = 28
horizontal_alignment = 1

[node name="DetectionIndicator" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 0
offset_left = 20.0
offset_top = 20.0
offset_right = 50.0
offset_bottom = 50.0
color = Color(0.5, 0.5, 0.5, 1)
