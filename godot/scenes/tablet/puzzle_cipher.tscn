[gd_scene load_steps=2 format=3 uid="uid://crv9qn5xr6pkae"]

[sub_resource type="GDScript" id="GDScript_cipher"]
script/source = "extends Control
## Cipher puzzle for adults - Memory 1 (decode the message)

signal puzzle_complete(success: bool, result: Dictionary)

@onready var title_label: Label = $TitleLabel
@onready var instruction_label: Label = $InstructionLabel
@onready var cipher_label: Label = $CipherPanel/CipherLabel
@onready var hint_label: Label = $HintLabel
@onready var answer_input: LineEdit = $AnswerInput
@onready var submit_button: Button = $SubmitButton
@onready var feedback_label: Label = $FeedbackLabel
@onready var hint_button: Button = $HintButton
@onready var hint_timer_label: Label = $HintTimerLabel

var puzzle_data: Dictionary = {}
var _correct_answer: String = \"\"
var _hint_available: bool = false
var _hint_timer: float = 0.0
var _hint_delay: float = 60.0
var _attempts: int = 0


func _ready() -> void:
	submit_button.pressed.connect(_on_submit)
	hint_button.pressed.connect(_on_hint_requested)
	answer_input.text_submitted.connect(_on_text_submitted)

	hint_button.visible = false
	hint_label.visible = false
	hint_timer_label.visible = true


func _process(delta: float) -> void:
	if not _hint_available:
		_hint_timer += delta
		var remaining := int(_hint_delay - _hint_timer)

		if remaining > 0:
			hint_timer_label.text = \"[SWEDISH: Hint available in %d seconds]\" % remaining
		else:
			_hint_available = true
			hint_timer_label.visible = false
			hint_button.visible = true


func setup(data: Dictionary) -> void:
	puzzle_data = data

	title_label.text = data.get(\"title\", \"[SWEDISH: Decode the message!]\")
	instruction_label.text = data.get(\"instructions\", \"[SWEDISH: Crack the code]\")
	cipher_label.text = data.get(\"cipher_text\", \"?\")
	_correct_answer = data.get(\"answer\", \"\").to_upper()

	# Store hint
	set_meta(\"hint_text\", data.get(\"hint\", \"[SWEDISH: A=1, B=2, C=3...]\"))

	feedback_label.text = \"\"


func _on_submit() -> void:
	_check_answer(answer_input.text)


func _on_text_submitted(text: String) -> void:
	_check_answer(text)


func _check_answer(answer: String) -> void:
	_attempts += 1
	var submitted := answer.strip_edges().to_upper()

	if submitted == _correct_answer:
		_on_correct_answer()
	else:
		_on_wrong_answer()


func _on_correct_answer() -> void:
	feedback_label.text = \"[SWEDISH: Correct! You decoded it!]\"
	feedback_label.add_theme_color_override(\"font_color\", Constants.Colors.SUCCESS_GREEN)

	answer_input.editable = false
	submit_button.disabled = true

	# Celebration
	var tween := create_tween()
	tween.tween_property(cipher_label, \"modulate\", Constants.Colors.HIGHLIGHT_GOLD, 0.3)

	await get_tree().create_timer(1.5).timeout

	puzzle_complete.emit(true, {
		\"answer\": _correct_answer,
		\"attempts\": _attempts
	})


func _on_wrong_answer() -> void:
	feedback_label.text = \"[SWEDISH: Not quite... try again!]\"
	feedback_label.add_theme_color_override(\"font_color\", Constants.Colors.ERROR_RED)

	# Shake animation
	var original_pos := answer_input.position
	var tween := create_tween()
	tween.tween_property(answer_input, \"position:x\", original_pos.x + 10, 0.05)
	tween.tween_property(answer_input, \"position:x\", original_pos.x - 10, 0.05)
	tween.tween_property(answer_input, \"position:x\", original_pos.x + 5, 0.05)
	tween.tween_property(answer_input, \"position:x\", original_pos.x, 0.05)

	# Clear input
	answer_input.text = \"\"
	answer_input.grab_focus()


func _on_hint_requested() -> void:
	hint_label.text = get_meta(\"hint_text\")
	hint_label.visible = true
	hint_button.visible = false

	# Subtle animation
	hint_label.modulate.a = 0.0
	var tween := create_tween()
	tween.tween_property(hint_label, \"modulate:a\", 1.0, 0.3)
"

[node name="PuzzleCipher" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource("GDScript_cipher")

[node name="Background" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(0.12, 0.15, 0.25, 1)

[node name="FrostOverlay" type="ColorRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
color = Color(0.8, 0.9, 1, 0.1)

[node name="TitleLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -300.0
offset_top = 30.0
offset_right = 300.0
offset_bottom = 80.0
theme_override_font_sizes/font_size = 36
horizontal_alignment = 1

[node name="InstructionLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -400.0
offset_top = 90.0
offset_right = 400.0
offset_bottom = 130.0
theme_override_font_sizes/font_size = 24
horizontal_alignment = 1
autowrap_mode = 2

[node name="CipherPanel" type="PanelContainer" parent="."]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -250.0
offset_top = -120.0
offset_right = 250.0
offset_bottom = -20.0
grow_horizontal = 2
grow_vertical = 2

[node name="CipherLabel" type="Label" parent="CipherPanel"]
layout_mode = 2
theme_override_font_sizes/font_size = 48
text = "19-11-1-16-5-20"
horizontal_alignment = 1
vertical_alignment = 1

[node name="HintLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -200.0
offset_top = 0.0
offset_right = 200.0
offset_bottom = 40.0
grow_horizontal = 2
grow_vertical = 2
theme_override_font_sizes/font_size = 20
theme_override_colors/font_color = Color(0.7, 0.8, 1, 1)
horizontal_alignment = 1

[node name="AnswerInput" type="LineEdit" parent="."]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -150.0
offset_top = 60.0
offset_right = 150.0
offset_bottom = 110.0
grow_horizontal = 2
grow_vertical = 2
theme_override_font_sizes/font_size = 28
placeholder_text = "[SWEDISH: Your answer]"
alignment = 1
caret_blink = true

[node name="SubmitButton" type="Button" parent="."]
layout_mode = 1
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -100.0
offset_top = 120.0
offset_right = 100.0
offset_bottom = 170.0
grow_horizontal = 2
grow_vertical = 2
theme_override_font_sizes/font_size = 24
text = "[SWEDISH: Submit]"

[node name="FeedbackLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 7
anchor_left = 0.5
anchor_top = 1.0
anchor_right = 0.5
anchor_bottom = 1.0
offset_left = -300.0
offset_top = -100.0
offset_right = 300.0
offset_bottom = -60.0
grow_horizontal = 2
grow_vertical = 0
theme_override_font_sizes/font_size = 28
horizontal_alignment = 1

[node name="HintButton" type="Button" parent="."]
layout_mode = 1
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -150.0
offset_top = 20.0
offset_right = -20.0
offset_bottom = 60.0
grow_horizontal = 0
theme_override_font_sizes/font_size = 18
text = "[SWEDISH: Show Hint]"

[node name="HintTimerLabel" type="Label" parent="."]
layout_mode = 1
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -200.0
offset_top = 20.0
offset_right = -20.0
offset_bottom = 50.0
grow_horizontal = 0
theme_override_font_sizes/font_size = 16
theme_override_colors/font_color = Color(0.6, 0.6, 0.6, 1)
horizontal_alignment = 2
